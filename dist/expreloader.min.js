!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("core-js/stable")):"function"==typeof define&&define.amd?define(["core-js/stable"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ExPreloader=t()}(this,(function(){"use strict";function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function asyncGeneratorStep(e,t,n,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){asyncGeneratorStep(o,r,i,a,c,"next",e)}function c(e){asyncGeneratorStep(o,r,i,a,c,"throw",e)}a(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var runtime={exports:{}};!function(e){var t=function(e){var t,n=Object.prototype,r=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function s(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof m?t:m,o=Object.create(i.prototype),a=new H(r||[]);return o._invoke=function(e,t,n){var r=h;return function(i,o){if(r===p)throw new Error("Generator is already running");if(r===g){if("throw"===i)throw o;return O()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var c=_(a,n);if(c){if(c===d)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=g,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=p;var s=l(e,t,n);if("normal"===s.type){if(r=n.done?g:f,s.arg===d)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r=g,n.method="throw",n.arg=s.arg)}}}(e,n,a),o}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var h="suspendedStart",f="suspendedYield",p="executing",g="completed",d={};function m(){}function y(){}function v(){}var b={};s(b,o,(function(){return this}));var w=Object.getPrototypeOf,x=w&&w(w(S([])));x&&x!==n&&r.call(x,o)&&(b=x);var P=v.prototype=m.prototype=Object.create(b);function k(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function n(i,o,a,c){var s=l(e[i],e,o);if("throw"!==s.type){var u=s.arg,h=u.value;return h&&"object"===_typeof(h)&&r.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,c)}),(function(e){n("throw",e,a,c)})):t.resolve(h).then((function(e){u.value=e,a(u)}),(function(e){return n("throw",e,a,c)}))}c(s.arg)}var i;this._invoke=function(e,r){function o(){return new t((function(t,i){n(e,r,t,i)}))}return i=i?i.then(o,o):o()}}function _(e,n){var r=e.iterator[n.method];if(r===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,_(e,n),"throw"===n.method))return d;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var i=l(r,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,d;var o=i.arg;return o?o.done?(n[e.resultName]=o.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,d):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,d)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function H(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function S(e){if(e){var n=e[o];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return a.next=a}}return{next:O}}function O(){return{value:t,done:!0}}return y.prototype=v,s(P,"constructor",v),s(v,"constructor",y),y.displayName=s(v,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,s(e,c,"GeneratorFunction")),e.prototype=Object.create(P),e},e.awrap=function(e){return{__await:e}},k(E.prototype),s(E.prototype,a,(function(){return this})),e.AsyncIterator=E,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new E(u(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(P),s(P,c,"Generator"),s(P,o,(function(){return this})),s(P,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=S,H.prototype={constructor:H,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return c.type="throw",c.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],c=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,d):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;L(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:S(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),d}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"===("undefined"==typeof globalThis?"undefined":_typeof(globalThis))?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}(runtime);var Utils=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"corsImage",value:function(e){return new Promise((function(t){GM.xmlHttpRequest({method:"GET",url:e,responseType:"arraybuffer",onload:function(e){var n=e.response,r=e.responseHeaders.split("\n").find((function(e){return/Content\-Type/i.test(e)})).trim().replace(/Content\-Type.?:/i,"").trim(),i=new Blob([n],{type:r});return t(i)}})}))}},{key:"extractImgHash",value:function extractImgHash(prevOnclickFn,nextOnclickFn){var prevImgHash=eval("\n            function load_image(n, hash){\n                return hash;\n            };\n            ".concat(prevOnclickFn,";\n            onclick(null)\n        ")),nextImgHash=eval("\n            function load_image(n, hash){\n                return hash;\n            };\n            ".concat(nextOnclickFn,";\n            onclick(null)\n        "));return{prevImgHash:prevImgHash,nextImgHash:nextImgHash}}},{key:"updateSize",value:function(e,t){var n=Math.max(700,window.innerWidth-70),r=e,i=t;r>n&&(i=Math.round(i*n/r),r=n);var o=document.getElementById("img"),a=document.getElementById("i1");o.style.maxWidth=r+"px",o.style.maxHeight=i+"px",a.style.maxWidth=r+20+"px"}}]),Utils}(),RequestAPI=function(e,t,n,r){return new Promise((function(i){var o=new XMLHttpRequest;o.onload=function(){var e=JSON.parse(o.responseText),t=e.i3,n=e.n,r=e.x,a=e.y,c=e.i;e.i2,e.i4;var s=e.i5,u=e.i6,l=e.i7,h=(new DOMParser).parseFromString(t,"text/html"),f=(new DOMParser).parseFromString(c,"text/html"),p=(new DOMParser).parseFromString(n,"text/html"),g=Utils.extractImgHash("function onclick(event) {".concat(p.getElementById("prev").getAttribute("onclick"),"}"),"function onclick(event) {".concat(p.getElementById("next").getAttribute("onclick"),"}")),d=g.prevImgHash,m=g.nextImgHash;return i({source:h.getElementById("img").getAttribute("src"),size:{width:r,height:a},prevImgHash:d,nextImgHash:m,html:{i2:n+c,i3:t,i4:c+n,i5:s,i6:u,i7:l,nextPageHref:h.querySelector("a").getAttribute("href")},name:f.querySelector("div").innerText.split("::")[0].trim()})},o.open("POST","/api.php"),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify({gid:e,imgkey:n,showkey:t,page:r,method:"showpage"}))}))},PageMetaStore=function(){function e(t,n){_classCallCheck(this,e);var r=document.querySelector("#i4 .sn div").innerText.split("/").map((function(e){return+e.trim()})),i=document.getElementById("img"),o={width:+i.style.width.replace(/[^0-9]+/,""),height:+i.style.height.replace(/[^0-9]+/,"")},a=Utils.extractImgHash(document.getElementById("prev").onclick.toString(),document.getElementById("next").onclick.toString()),c=a.prevImgHash,s=a.nextImgHash,u=new Array(r[1]).fill(null);u[r[0]-1]={size:o,prevImgHash:c,nextImgHash:s,source:i.src,binary:null,html:{i2:document.getElementById("i2").innerHTML,i4:document.getElementById("i4").innerHTML,i5:document.getElementById("i5").innerHTML,i6:document.getElementById("i6").innerHTML,i7:document.getElementById("i7").innerHTML,nextPageHref:document.querySelector("#i3 a").href},name:document.getElementById("i4").innerText.split("::")[0].trim()},this.getPage=function(e){return u[e-1]},this.setPage=function(e,t){u[e-1]=t},this.currentPage=r[0],this.maxPage=r[1],this.gid=t,this.showKey=n,this._preLookPage=5}var t;return _createClass(e,[{key:"updateCurrentPage",value:function(e){this.currentPage=e}},{key:"initPage",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r,i,o,a,c,s,u,l,h,f,p,g=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=g.length>2&&void 0!==g[2]?g[2]:null,i=this.currentPage-1,o=i>=this.preLookPage?this.preLookPage:i,a=i+this.preLookPage<=this.maxPage-1?this.preLookPage:this.maxPage-1-i,null!==(c=this.getPage(this.currentPage)).binary){e.next=10;break}return"function"==typeof t&&t("Binary",this.currentPage),e.next=9,Utils.corsImage(c.source);case 9:c.binary=e.sent;case 10:s=1;case 11:if(!(s<=o)){e.next=27;break}if(null!==this.getPage(i-s+1)){e.next=24;break}return"function"==typeof t&&t("MetaData",i-s+1),e.next=17,RequestAPI(this.gid,this.showKey,c.prevImgHash,i-s+1);case 17:return u=e.sent,"function"==typeof t&&t("Binary",i-s+1),e.next=21,Utils.corsImage(u.source);case 21:l=e.sent,c=_objectSpread2(_objectSpread2({},u),{},{binary:l}),this.setPage(i-s+1,c);case 24:s++,e.next=11;break;case 27:c=this.getPage(this.currentPage),h=1;case 29:if(!(h<=a)){e.next=45;break}if(null!==this.getPage(i+h+1)){e.next=42;break}return"function"==typeof t&&t("MetaData",i+h+1),e.next=35,RequestAPI(this.gid,this.showKey,c.nextImgHash,i+h+1);case 35:return f=e.sent,"function"==typeof t&&t("Binary",i+h+1),e.next=39,Utils.corsImage(f.source);case 39:p=e.sent,c=_objectSpread2(_objectSpread2({},f),{},{binary:p}),this.setPage(i+h+1,c);case 42:h++,e.next=29;break;case 45:"function"==typeof n&&n(),"function"==typeof r&&r();case 47:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"preLookPage",get:function(){return this._preLookPage},set:function(e){this._preLookPage=e}}]),e}(),ExPreloader=(privateMember=new WeakMap,_getVal=function(e,t){var n=privateMember.get(e);return void 0===n?void 0:n[t]},_setVal=function(e,t,n){var r=privateMember.get(e);if(void 0===r){var i={};return i[t]=n,void privateMember.set(e,i)}r[t]=n,privateMember.set(e,r)},resizeHandler=null,function(){function e(t,n){_classCallCheck(this,e);var r=new PageMetaStore(t,n);this.currentPage=r.currentPage,_setVal(this,"store",r),_setVal(this,"isInfoSet",!1)}var t;return _createClass(e,[{key:"preload",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=_getVal(this,"store"),e.next=3,r.initPage(t,n);case 3:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"updatePage",value:function(e){var t=this,n=_getVal(this,"store");n.updateCurrentPage(e);var r=n.getPage(e);null!==r&&function(){r=n.getPage(e),document.getElementById("i2").innerHTML=r.html.i2,document.getElementById("i4").innerHTML=r.html.i4,document.getElementById("i5").innerHTML=r.html.i5,document.getElementById("i6").innerHTML=r.html.i6,document.getElementById("i7").innerHTML=r.html.i7;var i,o=new Image,a=document.createElement("a");a.addEventListener("click",(function(t){load_image(e+1,r.nextImgHash)})),a.href=r.html.nextPageHref,o.setAttribute("id","img"),o.src=URL.createObjectURL(r.binary),o.style.width=r.size.width,o.style.height=r.size.height,a.appendChild(o),document.getElementById("i3").innerHTML="",document.getElementById("i3").appendChild(a),i=r.size,Utils.updateSize(i.width,i.height),t.currentPage=e}()}},{key:"listenResize",value:function(e){var t=this;if(new JSZip,!1===e){if(null===resizeHandler)return;window.removeEventListener("resize",resizeHandler),resizeHandler=null}else if(!0===e){if(null!==resizeHandler)return;resizeHandler=function(e){var n=_getVal(t,"store"),r=n.getPage(n.currentPage);Utils.updateSize(r.size.width,r.size.height)},window.addEventListener("resize",resizeHandler)}}},{key:"packStoredImg",value:function(e){for(var t=_getVal(this,"store"),n=new JSZip,r=1;r<=t.maxPage;r++){var i=t.getPage(r);null!==i&&n.file(i.name,i.binary)}n.generateAsync({type:"blob"}).then((function(t){var n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=document.querySelector("title").innerText.trim()+".zip",n.click(),"function"==typeof e&&e()}))}},{key:"installStatusInfo",value:function(){if(!_getVal(this,"isInfoSet")){var e=this,t=document.createElement("div");Object.assign(t.style,{padding:"1rem 0",textAlign:"center"});var n=document.createElement("div"),r=document.createElement("span");r.style.marginRight="1.5rem",n.appendChild(r);var i=document.createElement("button");i.innerText="下載目前緩存";var o=!0;return i.addEventListener("click",(function(t){o&&(o=!1,e.packStoredImg((function(){o=!0})))})),n.appendChild(i),document.getElementById("i1").insertBefore(n,document.getElementById("i2")),_setVal(this,"isInfoSet",!0),function(e,t){r.innerHTML="";var n=document.createElement("span");n.innerText=t,n.style.color=e?"red":"blue",n.style.fontSize="1rem",r.appendChild(n)}}}},{key:"maxPage",get:function(){return _getVal(this,"store").maxPage}},{key:"preLookPage",get:function(){return _getVal(this,"store").preLookPage},set:function(e){_getVal(this,"store").preLookPage=e}}]),e}()),privateMember,_getVal,_setVal,resizeHandler;return ExPreloader}));
